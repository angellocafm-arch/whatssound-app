# Diario WhatsSound ‚Äî 30 Enero 2026

## Sesi√≥n nocturna (00:00 - 02:15)

### Dise√±o de burbujas tipo WhatsApp
- Implementadas burbujas de chat estilo WhatsApp
- Mis mensajes ‚Üí derecha, fondo verde (#005c4b), borde verde brillante (#25d366)
- Mensajes de otros ‚Üí izquierda, fondo oscuro (#1f2c34), borde con color √∫nico por usuario
- Cada usuario tiene color diferente en grupos (paleta de 10 colores)
- `isMine` detectado via `supabase.auth.getSession()` (m√°s fiable que `getUser()`)

### Colores por usuario en grupos
- Paleta: rosa, morado, naranja, verde menta, rosa claro, lavanda, amarillo, cyan, rojo suave, verde lima
- Se asignan autom√°ticamente al primer mensaje de cada usuario
- En DMs funciona con 2 colores (verde m√≠o, azul otro)

### Funcionalidad de Grupos
- Nueva pantalla `/new-group` ‚Äî flujo en 2 pasos:
  1. Seleccionar miembros (checkboxes + chips)
  2. Nombrar grupo + preview de miembros
- Grupos almacenados como sessions con `genre='Group'`
- Member IDs en `current_song` (JSON) ‚Äî hack temporal sin schema change
- Header muestra icono de grupo + "X miembros"
- Mini player oculto en grupos (solo en sesiones musicales)

### Test completo con 3 usuarios
- Kike, √Ångel, Admin ‚Äî probados como usuario real
- Kike crea grupo "Equipo WhatsSound üöÄ" con Admin y √Ångel
- Los 3 env√≠an mensajes y los ven correctamente
- Capturas: test-01 a test-14 en /docs/diary/

### Integraci√≥n Deezer
- Proxy Deezer propio desplegado en Vercel (`/api/deezer`)
- B√∫squeda funciona: Bad Bunny devuelve resultados reales
- Preview URLs de 30 segundos incluidos
- Componente MusicPlayer creado (HTML5 Audio)
- Capturas: music-search-01, music-search-02

### Decisiones
- Estrategia musical: Opci√≥n 2 ‚Äî API √∫nica de WhatsSound, sin cuentas individuales de Deezer, previews 30s gratis
- Escalabilidad preparada para OAuth personal cuando crezca

### Bugs corregidos
- JSON de members visible en chat ‚Üí ocultado
- "Daddy Yankee" en header de grupo ‚Üí mini player ocultado para chat modes
- `getUser()` fallaba en China ‚Üí migrado a `getSession()`
- CORS proxy (corsproxy.io) ca√≠do ‚Üí proxy propio en Vercel

### Integraci√≥n Deezer + Tarjetas de canci√≥n en chat
- Proxy Deezer propio en Vercel (`/api/deezer`) ‚Äî sin l√≠mites, sin CORS
- B√∫squeda Deezer funciona: Bad Bunny, Rosal√≠a, Shakira con car√°tulas reales
- Preview URLs 30s incluidos en los resultados
- **Tarjetas de canci√≥n en el chat** ‚Äî mensajes especiales `is_system=true` con JSON
  - Car√°tula + t√≠tulo + artista + √°lbum + duraci√≥n
  - Botones üî• "¬°La quiero!" y ‚è≠Ô∏è "Skip"
  - Footer: "Kike a√±adi√≥ esta canci√≥n" / "T√∫ a√±adi√≥ esta canci√≥n"
- Mini reproductor fijo con ‚ñ∂Ô∏è y ‚¨ÜÔ∏è expand
- Playlist expandible preparada (bot√≥n üí¨ para mencionar canci√≥n)
- Flujo: DJ busca ‚Üí pide canci√≥n ‚Üí aparece como tarjeta en el chat ‚Üí usuarios votan

### Bug cr√≠tico: Auth init hang en China
- **Problema**: `supabase.auth.getSession()` colgaba indefinidamente en redes lentas
- **Causa**: Supabase JS v2 intenta `_recoverAndRefresh()` que hace network call ‚Üí AbortError en China
- **S√≠ntoma**: App mostraba spinner infinito, `initialized` nunca se pon√≠a a `true`
- **Soluci√≥n**: 
  1. Timeout de 5s en `getSession()`
  2. Restaurar sesi√≥n directamente de localStorage (sin red)
  3. `autoRefreshToken: false` para evitar refresh autom√°tico
  4. Fetch de mensajes con `fetch()` directo en vez de `supabase.from().select()`
  5. Custom localStorage adapter en vez de AsyncStorage para web
- **Resultado**: La app carga en <2 segundos

### Screenshots guardados
~30 capturas en /docs/diary/ y /tmp/
